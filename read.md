# 顔年齢推定（Face-Age-10K）プロジェクトまとめ

## 1. 学習の3要素 (Core Scripts)
プロジェクトを機能ごとに分離することで、保守性と再現性を確保しています。

| ファイル名 | 役割 | 主な機能 |
| :--- | :--- | :--- |
| **dataset.py** | データの整備 | データのロード、不均衡調整（アンダーサンプリング）、DataLoaderの作成。 |
| **pytorchCNNnew.py** | 学習の実装 | モデル定義、学習ループ（Loss計算・重み更新）、チェックポイント保存。 |
| **load.py** | 推論の実行 | 学習済みモデルのロード、外部画像の取得、予測結果の出力。 |

---

## 2. モデル定義一覧 (model.md)
`MyCNN` クラスのアーキテクチャ詳細です。

* **Conv層**: 4層の畳み込み層。チャンネル数を `3 -> 32 -> 64 -> 128 -> 256` と段階的に増加。
* **Pooling**: `MaxPool2d(2, 2)` による空間情報の圧縮。
* **Regularization**: `Dropout(0.5)` による過学習の抑制。
* **GAP**: `AdaptiveAvgPool2d((1, 1))` を採用。全結合層への入力を固定し、様々な入力解像度に対応。
* **出力**: `Linear(256, 8)`。8つの年齢層クラスに対応。

---

## 3. 学習時の問題と解決策 (今回の問題.md)

### ⚠️ クラス・バイアス（データの偏り）
* **内容**: 子供（Class 0）のデータが他より圧倒的に多く、モデルが「とりあえず子供」と答える安易な学習に陥った。
* **解決**: `groupby('label').sample(n=min_count)` によるアンダーサンプリングを実施し、全クラスを344枚（最小クラス）に統一。

### ⚠️ 前処理（Transform）の不一致
* **内容**: 学習時と推論時で正規化（Normalize）の有無がズレていたため、モデルが画像を正しく認識できなかった。
* **解決**: `mean=0.5, std=0.5` の設定を学習・推論の双方で共通化。

### ⚠️ インポート時のサイドエフェクト
* **内容**: `load.py` を実行しただけで、インポート元の `dataset.py` の学習用データ準備が走り出してしまった。
* **解決**: `if __name__ == "__main__":` ガードを徹底し、実行コードを関数内に隠蔽。

### ⚠️ 外部画像取得エラー
* **内容**: URLから取得したデータが画像でない（HTMLエラー等）場合、PIL が `UnidentifiedImageError` を吐いて停止。
* **解決**: `response.status_code` のチェックと `try-except` による例外処理を追加。

---

## 4. 必要な関数一覧 (一覧.md)

### 🔹 dataset.py
* `load_dataset()`: Hugging Faceからデータセットを取得。
* `train_test_split(..., stratify=df['label'])`: ラベル比率を維持したまま分割。
* `MyDataset(Dataset)`: NumPy配列をPILに戻し、RGB変換してTensorを返すカスタムクラス。

### 🔹 pytorchCNNnew.py
* `train()`: 学習のメインループ。`Counter` によるリアルタイムのラベル集計を含む。
* `optimizer.zero_grad()` / `loss.backward()`: 重みの更新サイクル。
* `torch.save()`: モデルのパラメータ（`state_dict`）をファイルに保存。

### 🔹 load.py
* `model.load_state_dict()`: 保存された重みの読み込み。
* `model.eval()` / `torch.no_grad()`: 推論専用モードへの切り替えとメモリ節約。
* `requests.get()`: 外部URLからの画像データ取得。

---

## 💡 技術的な学び
* **「鏡合わせの原則」**: 学習時と推論時の画像処理（Normalize/Resize）は寸分違わず一致させる必要がある。
* **「データバランスの重要性」**: AIは数が多い方に流されやすいため、前処理段階での調整が精度に直結する。
* **「型の変換」**: `NumPy -> PIL -> Tensor` という流れを理解することで、torchvision の機能を最大限活用できる。