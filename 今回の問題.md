# PyTorch 画像分類プロジェクト：トラブルシューティング・レポート

## 1. 発生していた問題（なぜ大人の顔が子供と判定されたか）

モデルがすべての画像を「クラス0（0-10歳）」と予測してしまった原因は、主に以下の3点に集約されます。

### A. データの不均衡（データ・バイアス）
* **現象:** 学習データの約25%が「クラス0」であり、特定のクラス（クラス7など）は非常に少なかった。
* **原因:** モデルが「とりあえずクラス0と答えておけば効率よく損失（Loss）を下げられる」という局所解に陥った。

### B. 前処理（Transform）の不一致
* **現象:** 学習時は「正規化（Normalize）」をしていなかったが、推論時（load.py）だけ「Normalize」を実行していた。
* **原因:** 正規化によって入力データの数値範囲が [0, 1] から [-1, 1] に変わったため、モデルにとって未知のデータ（全く別の色の画像）に見えていた。

### C. 学習率（Learning Rate）の不適合
* **現象:** `lr=0.01` で Adam 最適化を行っていた。
* **原因:** CNNの学習には少し高すぎたため、細かい特徴を捉える前に大まかなデータの数に引きずられた学習が進んでしまった。

---

## 2. 実施した解決策

### ① アンダーサンプリングによるデータ数の統一
* **内容:** 最も枚数の少ないクラス（275枚）に合わせて、全クラスのデータをランダムに275枚ずつ抽出。
* **効果:** クラスごとの「数の暴力」がなくなり、各年齢層の特徴を平等に学習できるようになった。

### ② 前処理の完全統一
* **内容:** `Resize((128, 128))` と `Normalize(mean=0.5, std=0.5)` を学習・テスト・推論のすべてで共通化。
* **効果:** モデルが学習した「色の感覚」と、推論時の「色の感覚」が完全に一致した。

### ③ 学習パラメータの調整
* **内容:** 学習率を `lr=0.001` に引き下げ、エポック数を 10 に増加。
* **効果:** 損失関数が安定して減少し、より深い特徴抽出が可能になった。

---

## 3. エンジニアとしての今後のチェックリスト

1. **データ分布を確認する**
   - `df['label'].value_counts()` を実行し、極端な偏りがないか見る。偏りがあるなら「重み付け」か「サンプリング調整」が必要。

2. **Normalizeの有無を揃える**
   - `transforms.Normalize` を使うなら、学習・検証・推論のすべてで同じ `mean` と `std` を使う。

3. **インポートガード（if __name__ == "__main__":）の徹底**
   - モデル定義ファイルやデータ作成ファイルを他のスクリプト（load.pyなど）から読み込む際、意図しないコードが走らないようガードをかける。

4. **NumPy/PIL/Tensor の型変換を意識する**
   - `Image.fromarray(np_array)` や `transforms.ToTensor()` の流れを整理し、データの型エラーを未然に防ぐ。

---

## 4. 推奨されるディレクトリ構成

.
├── dataset.py        # データの整形・統一・DataLoader作成
├── pytorchCNNnew.py  # モデル定義・学習（メイン実行ファイル）
├── load.py           # 推論用スクリプト（学習済みモデルを読み込んで実行）
└── checkpoints/      # final.pth などのモデル保存用フォルダ